<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscando Huellas</title>
    
    <!-- 1. Cargar React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 2. Cargar Babel para traducir JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 4. Cargar Leaflet (Mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Estilos y Animaciones Personalizadas -->
    <style>
        /* Animaciones personalizadas que Tailwind no trae por defecto */
        @keyframes scan { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .animate-scan { animation: scan 2s linear infinite; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Fix para el mapa Leaflet en este entorno */
        .custom-div-icon { background: transparent; border: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-emerald-100 selection:text-emerald-800">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONOS SVG INLINE (Para no depender de librerías externas) ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Heart = (props) => <IconBase {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5 4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>;
        const Camera = (props) => <IconBase {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>;
        const MapPin = (props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const ArrowLeft = (props) => <IconBase {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const MapIcon = (props) => <IconBase {...props}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;

        // --- DATOS INICIALES ---
        const INITIAL_FOUND_DOGS = [
            {
                id: 1,
                breed: "Mestizo / Beige",
                location: "Parque Central, Zona Norte",
                gps: { lat: 19.4350, lng: -99.1350 },
                description: "Encontrado cerca de los columpios. Tiene un collar rojo sin placa.",
                date: "Hace 2 horas",
                image: "https://images.unsplash.com/photo-1517849845537-4d257902454a?w=400&h=400&fit=crop"
            },
            {
                id: 2,
                breed: "Golden Retriever",
                location: "Av. Principal con Calle 5",
                gps: { lat: 19.4310, lng: -99.1310 },
                description: "Parece asustado, muy dócil. Estaba esperando frente a la panadería.",
                date: "Ayer a las 18:00",
                image: "https://images.unsplash.com/photo-1552053831-71594a27632d?w=400&h=400&fit=crop"
            },
            {
                id: 3,
                breed: "Schnauzer",
                location: "Cerca del centro comercial",
                gps: { lat: 19.4380, lng: -99.1300 },
                description: "Lleva un suéter azul. Se deja acariciar.",
                date: "Hoy a las 09:30",
                image: "https://images.unsplash.com/photo-1534361960057-19889db9621e?w=400&h=400&fit=crop"
            }
        ];

        // --- COMPONENTES ---

        // Componente Mapa
        const OpenStreetMap = ({ onLocationSelect, initialCoords, readOnly = false }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerRef = useRef(null);
            const defaultCenter = initialCoords || { lat: 19.4326, lng: -99.1332 };

            useEffect(() => {
                // Verificar que Leaflet (L) esté cargado globalmente
                if (window.L && mapContainerRef.current && !mapInstanceRef.current) {
                    const map = L.map(mapContainerRef.current).setView([defaultCenter.lat, defaultCenter.lng], 15);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #ef4444; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    if (initialCoords) {
                        markerRef.current = L.marker([initialCoords.lat, initialCoords.lng], { icon }).addTo(map);
                    }

                    if (!readOnly) {
                        map.on('click', (e) => {
                            const { lat, lng } = e.latlng;
                            if (markerRef.current) {
                                markerRef.current.setLatLng([lat, lng]);
                            } else {
                                markerRef.current = L.marker([lat, lng], { icon }).addTo(map);
                            }
                            if(onLocationSelect) onLocationSelect({ lat, lng });
                        });
                    }

                    mapInstanceRef.current = map;
                    
                    // Fix de renderizado
                    setTimeout(() => map.invalidateSize(), 200);
                }

                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                    }
                };
            }, [readOnly]);

            return (
                <div className="relative w-full h-64 rounded-xl overflow-hidden shadow-inner border-2 border-slate-200 z-0 bg-slate-100">
                    <div ref={mapContainerRef} className="w-full h-full"></div>
                    {!readOnly && (
                        <div className="absolute top-2 right-2 bg-white/90 px-3 py-1 rounded-full text-xs font-medium text-slate-600 shadow-sm z-[1000] pointer-events-none border border-slate-100">
                            Toca para marcar
                        </div>
                    )}
                </div>
            );
        };

        const LocationSelector = ({ onLocationChange }) => {
            const [coords, setCoords] = useState(null);
            
            const handleMapSelect = (latLng) => {
                setCoords(latLng);
                onLocationChange({
                    gps: latLng,
                    link: `https://www.google.com/maps/search/?api=1&query=${latLng.lat},${latLng.lng}`
                });
            };

            return (
                <div className="space-y-3">
                    <OpenStreetMap onLocationSelect={handleMapSelect} />
                    {coords ? (
                        <div className="flex items-center gap-2 text-xs text-emerald-600 bg-emerald-50 p-2 rounded-lg border border-emerald-100">
                            <CheckCircle className="w-4 h-4" />
                            <span>Ubicación: {coords.lat.toFixed(4)}, {coords.lng.toFixed(4)}</span>
                        </div>
                    ) : (
                        <div className="flex items-center gap-2 text-xs text-slate-500 bg-slate-50 p-2 rounded-lg border border-slate-200">
                            <AlertCircle className="w-4 h-4" />
                            <span>Haz clic en el mapa para marcar el lugar.</span>
                        </div>
                    )}
                </div>
            );
        };

        const DogCard = ({ dog, isMatch = false }) => {
            const mapsLink = dog.gps 
                ? `https://www.google.com/maps/search/?api=1&query=${dog.gps.lat},${dog.gps.lng}` 
                : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dog.location)}`;

            return (
                <div className={`bg-white rounded-xl shadow-sm border overflow-hidden transition-all hover:shadow-md ${isMatch ? 'border-amber-400 ring-2 ring-amber-100' : 'border-slate-100'}`}>
                    <div className="relative h-48 bg-slate-200 group">
                        <img src={dog.image} alt={dog.breed} className="w-full h-full object-cover transition-transform group-hover:scale-105" />
                        {isMatch && (
                            <div className="absolute top-2 right-2 bg-amber-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-sm flex items-center gap-1 z-10">
                                <Search className="w-3 h-3" /> 94% Similitud
                            </div>
                        )}
                    </div>
                    
                    <div className="p-4">
                        <div className="flex justify-between items-start mb-2">
                            <h3 className="font-bold text-slate-800">{dog.breed}</h3>
                            <span className="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full">{dog.date}</span>
                        </div>
                        <p className="text-sm text-slate-600 mb-3 line-clamp-2">{dog.description}</p>
                        
                        <div className="space-y-2">
                            <div className="flex items-start text-xs text-slate-500 gap-1.5 bg-slate-50 p-2 rounded-lg">
                                <MapPin className="w-3.5 h-3.5 mt-0.5 text-emerald-500 flex-shrink-0" />
                                <span className="line-clamp-2">{dog.location}</span>
                            </div>
                            
                            <a href={mapsLink} target="_blank" rel="noopener noreferrer"
                               className="block w-full text-center py-2 border border-emerald-200 text-emerald-600 font-medium rounded-lg text-sm hover:bg-emerald-50 transition-colors flex items-center justify-center gap-2">
                                <MapIcon className="w-4 h-4" />
                                Abrir en Google Maps
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [view, setView] = useState('home'); 
            const [foundDogs, setFoundDogs] = useState(INITIAL_FOUND_DOGS);
            const [formData, setFormData] = useState({ image: null, breed: '', locationDescription: '', locationData: null, desc: '' });
            const [searchImage, setSearchImage] = useState(null);
            const [isScanning, setIsScanning] = useState(false);

            const goHome = () => {
                setView('home');
                setFormData({ image: null, breed: '', locationDescription: '', locationData: null, desc: '' });
                setSearchImage(null);
                setIsScanning(false);
            };

            const handleImageUpload = (e, type) => {
                const file = e.target.files[0];
                if (file) {
                    const imageUrl = URL.createObjectURL(file);
                    if (type === 'report') {
                        setFormData({ ...formData, image: imageUrl });
                    } else {
                        setSearchImage(imageUrl);
                        setIsScanning(true);
                        setTimeout(() => {
                            setIsScanning(false);
                            setView('results');
                        }, 2500);
                    }
                }
            };

            const handleReportSubmit = () => {
                const newDog = {
                    id: foundDogs.length + 1,
                    breed: formData.breed || "Raza desconocida",
                    location: formData.locationDescription || "Ubicación marcada en mapa",
                    gps: formData.locationData?.gps,
                    description: formData.desc,
                    date: "Recién reportado",
                    image: formData.image
                };
                setFoundDogs([newDog, ...foundDogs]);
                setView('success');
            };

            // VISTAS
            const renderHome = () => (
                <div className="flex flex-col items-center justify-center min-h-[80vh] px-4 space-y-8 animate-fade-in">
                    <div className="text-center space-y-2">
                        <div className="inline-flex items-center justify-center w-20 h-20 bg-emerald-100 rounded-full mb-4 shadow-lg ring-4 ring-white">
                            <Heart className="w-10 h-10 text-emerald-600 fill-emerald-600" />
                        </div>
                        <h1 className="text-4xl font-extrabold text-slate-800 tracking-tight">Buscando Huellas</h1>
                        <p className="text-lg text-slate-500 max-w-md mx-auto">La comunidad que une corazones. Reporta perritos encontrados o encuentra a tu mejor amigo.</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                        <button onClick={() => setView('report')} className="group relative overflow-hidden bg-white p-8 rounded-2xl shadow-md border-2 border-transparent hover:border-emerald-400 hover:shadow-xl transition-all text-left">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <Camera className="w-24 h-24 text-emerald-500" />
                            </div>
                            <div className="bg-emerald-100 w-12 h-12 rounded-lg flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                <MapIcon className="w-6 h-6 text-emerald-600" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800 mb-2">Encontré un perrito</h2>
                            <p className="text-slate-500 text-sm">Reporta un avistamiento usando un mapa interactivo preciso.</p>
                        </button>

                        <button onClick={() => setView('find')} className="group relative overflow-hidden bg-white p-8 rounded-2xl shadow-md border-2 border-transparent hover:border-amber-400 hover:shadow-xl transition-all text-left">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <Search className="w-24 h-24 text-amber-500" />
                            </div>
                            <div className="bg-amber-100 w-12 h-12 rounded-lg flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                <Search className="w-6 h-6 text-amber-600" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800 mb-2">Perdí a mi perrito</h2>
                            <p className="text-slate-500 text-sm">Sube una foto y encontraremos coincidencias cercanas.</p>
                        </button>
                    </div>
                </div>
            );

            const renderReport = () => (
                <div className="max-w-xl mx-auto animate-fade-in-up">
                    <div className="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                        <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                            <Camera className="w-6 h-6 text-emerald-500" />
                            Reportar Perrito Encontrado
                        </h2>

                        <div className="space-y-6">
                            <div className="space-y-2">
                                <label className="block text-sm font-medium text-slate-700">1. Foto del perrito</label>
                                <div className="relative group">
                                    <div className={`border-2 border-dashed rounded-xl h-40 flex flex-col items-center justify-center cursor-pointer transition-colors ${formData.image ? 'border-emerald-500 bg-emerald-50' : 'border-slate-300 hover:border-emerald-400 hover:bg-slate-50'}`}>
                                        {formData.image ? (
                                            <div className="relative w-full h-full p-2">
                                                <img src={formData.image} className="w-full h-full object-cover rounded-lg" alt="Preview" />
                                                <button onClick={() => setFormData({...formData, image: null})} className="absolute top-3 right-3 bg-white p-1 rounded-full shadow-md hover:bg-red-50 text-red-500"><X className="w-4 h-4"/></button>
                                            </div>
                                        ) : (
                                            <>
                                                <Upload className="w-8 h-8 text-slate-400 mb-2 group-hover:text-emerald-500" />
                                                <span className="text-sm text-slate-500">Subir foto</span>
                                            </>
                                        )}
                                        <input type="file" accept="image/*" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={(e) => handleImageUpload(e, 'report')} disabled={formData.image !== null} />
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-2">
                                <label className="block text-sm font-medium text-slate-700">2. Ubicación exacta (Usa el mapa)</label>
                                <LocationSelector onLocationChange={(data) => setFormData({ ...formData, locationData: data })} />
                                <input type="text" placeholder="Referencia escrita (Ej: Frente al banco...)"
                                    className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm mt-2"
                                    value={formData.locationDescription}
                                    onChange={(e) => setFormData({...formData, locationDescription: e.target.value})}
                                />
                            </div>

                            <div className="space-y-2">
                                <label className="block text-sm font-medium text-slate-700">3. Descripción</label>
                                <textarea rows="2" placeholder="Detalles importantes..."
                                    className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm resize-none"
                                    value={formData.desc}
                                    onChange={(e) => setFormData({...formData, desc: e.target.value})}
                                />
                            </div>

                            <button disabled={!formData.image || !formData.locationData} onClick={handleReportSubmit}
                                className={`w-full py-3 rounded-xl font-bold text-lg shadow-md transition-all ${!formData.image || !formData.locationData ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-emerald-500 hover:bg-emerald-600 text-white transform hover:scale-[1.02]'}`}>
                                Publicar Reporte
                            </button>
                        </div>
                    </div>
                </div>
            );

            const renderFind = () => (
                <div className="max-w-xl mx-auto animate-fade-in-up">
                    <div className="bg-white rounded-2xl shadow-lg p-6 md:p-8 text-center">
                        {!isScanning ? (
                            <>
                                <h2 className="text-2xl font-bold text-slate-800 mb-2">Subir foto de referencia</h2>
                                <p className="text-slate-500 mb-6 text-sm">El sistema buscará coincidencias visuales.</p>
                                <div className="relative border-2 border-dashed border-amber-300 bg-amber-50 rounded-2xl h-64 flex flex-col items-center justify-center cursor-pointer hover:bg-amber-100 transition-colors group">
                                    <Upload className="w-12 h-12 text-amber-500 mb-3 group-hover:scale-110 transition-transform" />
                                    <span className="font-medium text-amber-700">Subir foto de mi perrito</span>
                                    <input type="file" accept="image/*" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={(e) => handleImageUpload(e, 'find')} />
                                </div>
                            </>
                        ) : (
                            <div className="py-12 flex flex-col items-center justify-center space-y-6">
                                <div className="relative">
                                    <div className="w-32 h-32 rounded-full overflow-hidden border-4 border-slate-100 shadow-inner relative z-10">
                                        <img src={searchImage} className="w-full h-full object-cover opacity-80" alt="Scanning" />
                                    </div>
                                    <div className="absolute inset-0 bg-emerald-500/20 z-20 animate-scan"></div>
                                    <div className="absolute -inset-4 border-t-4 border-emerald-500 rounded-full animate-spin"></div>
                                </div>
                                <div className="space-y-2">
                                    <h3 className="text-xl font-bold text-slate-800 animate-pulse">Buscando...</h3>
                                    <p className="text-slate-500 text-sm">Escaneando base de datos.</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            const renderResults = () => (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-start gap-3">
                        <CheckCircle className="w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5" />
                        <div>
                            <h3 className="font-bold text-amber-800">Resultados Encontrados</h3>
                            <p className="text-sm text-amber-700">Perritos con características similares.</p>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {foundDogs.map((dog) => <DogCard key={dog.id} dog={dog} isMatch={true} />)}
                    </div>
                </div>
            );

            const renderSuccess = () => (
                <div className="flex flex-col items-center justify-center py-12 text-center animate-fade-in-up">
                    <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6">
                        <CheckCircle className="w-10 h-10 text-green-600" />
                    </div>
                    <h2 className="text-3xl font-bold text-slate-800 mb-2">¡Reporte publicado!</h2>
                    <p className="text-slate-500 max-w-md mb-8">La ubicación ha sido registrada en el mapa público.</p>
                    <button onClick={goHome} className="bg-emerald-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-emerald-600 transition-transform transform hover:scale-105">Volver al Inicio</button>
                </div>
            );

            return (
                <div className="min-h-screen">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50">
                        <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                            <button onClick={goHome} className="flex items-center gap-2 group">
                                <Heart className="w-6 h-6 text-emerald-500 fill-emerald-500 group-hover:scale-110 transition-transform" />
                                <span className="font-bold text-xl tracking-tight text-slate-800">Buscando<span className="text-emerald-500">Huellas</span></span>
                            </button>
                            {view !== 'home' && (
                                <button onClick={goHome} className="text-sm font-medium text-slate-500 hover:text-emerald-600 flex items-center gap-1">
                                    <ArrowLeft className="w-4 h-4" /> Inicio
                                </button>
                            )}
                        </div>
                    </header>
                    <main className="max-w-5xl mx-auto px-4 py-8 md:py-12">
                        {view === 'home' && renderHome()}
                        {view === 'report' && renderReport()}
                        {view === 'find' && renderFind()}
                        {view === 'results' && renderResults()}
                        {view === 'success' && renderSuccess()}
                    </main>
                    
                    <footer className="bg-white border-t border-slate-200 py-8 mt-auto">
                        <div className="max-w-5xl mx-auto px-4 text-center text-slate-400 text-sm">
                            <p>© 2024 BuscandoHuellas. Un proyecto para unir mascotas con sus familias.</p>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>