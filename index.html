<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscando Huellas</title>
    
    <!-- 1. Cargar React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 2. Cargar Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. Cargar Estilos (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 4. Cargar Mapas (Leaflet) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- 5. FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @keyframes scan { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .animate-scan { animation: scan 2s linear infinite; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .custom-div-icon { background: transparent; border: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans selection:bg-emerald-100 selection:text-emerald-800">
    
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ‚öôÔ∏è CONFIGURACI√ìN DE FIREBASE (¬°EDITAR ESTO!)
        // ==========================================
        const firebaseConfig = {
            // üëá PEGA AQU√ç TUS CREDENCIALES:
            apiKey: "AIzaSyDuLmcN4aHVHXjLhmgt7tNS_ghSV-VaEjM",
  authDomain: "buscando-huellas-8dbeb.firebaseapp.com",
  projectId: "buscando-huellas-8dbeb",
  storageBucket: "buscando-huellas-8dbeb.firebasestorage.app",
  messagingSenderId: "564781262538",
  appId: "1:564781262538:web:5e0c1281f215461edf3633"
        };

        // Inicializar Firebase
        let db = null;
        try {
            if (firebaseConfig.apiKey !== "TU_API_KEY_AQUI" && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("üî• Firebase conectado");
            } else if (firebase.apps.length) {
                db = firebase.firestore();
            }
        } catch (e) {
            console.error("Error Firebase:", e);
        }

        const { useState, useEffect, useRef } = React;

        // --- ICONOS ---
        const IconBase = ({ d, c, f="none" }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={f} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={c}>{d}</svg>;
        
        const Heart = (p) => <IconBase {...p} d={<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5 4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>} />;
        const Camera = (p) => <IconBase {...p} d={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />;
        const Search = (p) => <IconBase {...p} d={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />;
        const MapIcon = (p) => <IconBase {...p} d={<><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></>} />;
        const CheckCircle = (p) => <IconBase {...p} d={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const Upload = (p) => <IconBase {...p} d={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />;
        
        // --- UTILIDADES ---
        const resizeImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 500;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    }
                }
            });
        };

        // --- COMPONENTE MAPA ---
        const InteractiveMap = ({ onLocationSelect, initialCoords, readOnly }) => {
            const containerRef = useRef(null);
            const mapRef = useRef(null);
            const markerRef = useRef(null);

            useEffect(() => {
                if (!window.L || !containerRef.current) return;
                if (!mapRef.current) {
                    const defaultCoords = initialCoords || { lat: 19.4326, lng: -99.1332 };
                    mapRef.current = L.map(containerRef.current).setView([defaultCoords.lat, defaultCoords.lng], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(mapRef.current);

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #ef4444; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    if (initialCoords) markerRef.current = L.marker([initialCoords.lat, initialCoords.lng], { icon }).addTo(mapRef.current);
                    if (!readOnly) {
                        mapRef.current.on('click', (e) => {
                            const { lat, lng } = e.latlng;
                            if (markerRef.current) markerRef.current.setLatLng([lat, lng]);
                            else markerRef.current = L.marker([lat, lng], { icon }).addTo(mapRef.current);
                            onLocationSelect({ lat, lng });
                        });
                    }
                    setTimeout(() => mapRef.current.invalidateSize(), 500);
                }
            }, []);
            return <div ref={containerRef} className="w-full h-64 bg-slate-100 rounded-xl z-0 border border-slate-300 relative" />;
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [view, setView] = useState('home');
            const [dogs, setDogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [uploading, setUploading] = useState(false);
            const [form, setForm] = useState({ image: null, breed: '', desc: '', coords: null });
            const [searchImage, setSearchImage] = useState(null);

            useEffect(() => {
                if (!db) { setLoading(false); return; }
                const unsubscribe = db.collection("dogs").onSnapshot((snapshot) => {
                        const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setDogs(docs);
                        setLoading(false);
                    }, () => setLoading(false));
                return () => unsubscribe();
            }, []);

            const handlePublish = async () => {
                if (!form.image || !form.coords) return;
                setUploading(true);
                try {
                    if (db) {
                        await db.collection("dogs").add({
                            breed: form.breed || "Desconocido",
                            description: form.desc,
                            image: form.image,
                            gps: form.coords,
                            location: form.locationDesc || "Ubicaci√≥n en mapa",
                            date: new Date().toLocaleDateString(),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setForm({ image: null, breed: '', desc: '', coords: null });
                        setView('success');
                    } else {
                        alert("‚ö†Ô∏è Configura las llaves de Firebase en el c√≥digo.");
                        setView('success');
                    }
                } catch (e) { alert("Error: " + e.message); }
                setUploading(false);
            };

            const handleImage = async (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                const base64 = await resizeImage(file);
                if (type === 'report') setForm({ ...form, image: base64 });
                else { setSearchImage(base64); setView('results'); }
            };

            // --- VISTAS ---
            
            // HOME RESTAURADO (Dise√±o Premium)
            if (view === 'home') return (
                <div className="flex flex-col items-center justify-center min-h-[80vh] px-4 space-y-8 animate-fade-in">
                    <div className="text-center space-y-2">
                        <div className="inline-flex items-center justify-center w-20 h-20 bg-emerald-100 rounded-full mb-4 shadow-lg ring-4 ring-white">
                            <Heart c="w-10 h-10 text-emerald-600 fill-emerald-600" f="currentColor" />
                        </div>
                        <h1 className="text-4xl font-extrabold text-slate-800 tracking-tight">Buscando Huellas</h1>
                        <p className="text-lg text-slate-500 max-w-md mx-auto">La comunidad que une corazones. Reporta perritos encontrados o encuentra a tu mejor amigo.</p>
                        {!db && <div className="mt-4 bg-amber-50 text-amber-800 text-xs p-2 rounded border border-amber-200 inline-block">‚ö†Ô∏è Modo Demo: Faltan llaves de Firebase</div>}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                        {/* Bot√≥n 1: Reportar */}
                        <button onClick={() => setView('report')} className="group relative overflow-hidden bg-white p-8 rounded-2xl shadow-md border-2 border-transparent hover:border-emerald-400 hover:shadow-xl transition-all text-left">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <Camera c="w-24 h-24 text-emerald-500" />
                            </div>
                            <div className="bg-emerald-100 w-12 h-12 rounded-lg flex items-center justify-center mb-4 group-hover:scale-110 transition-transform relative z-10">
                                <MapIcon c="w-6 h-6 text-emerald-600" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800 mb-2 relative z-10">Encontr√© un perrito</h2>
                            <p className="text-slate-500 text-sm relative z-10">Si viste un perrito perdido, sube su foto y ubicaci√≥n para ayudarlo.</p>
                        </button>

                        {/* Bot√≥n 2: Buscar */}
                        <button onClick={() => setView('find')} className="group relative overflow-hidden bg-white p-8 rounded-2xl shadow-md border-2 border-transparent hover:border-amber-400 hover:shadow-xl transition-all text-left">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <Search c="w-24 h-24 text-amber-500" />
                            </div>
                            <div className="bg-amber-100 w-12 h-12 rounded-lg flex items-center justify-center mb-4 group-hover:scale-110 transition-transform relative z-10">
                                <Search c="w-6 h-6 text-amber-600" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800 mb-2 relative z-10">Perd√≠ a mi perrito</h2>
                            <p className="text-slate-500 text-sm relative z-10">Sube una foto de tu mascota y busca coincidencias recientes.</p>
                        </button>
                    </div>
                </div>
            );

            if (view === 'report') return (
                <div className="min-h-screen p-4 max-w-lg mx-auto animate-fade-in">
                    <button onClick={() => setView('home')} className="text-slate-500 mb-4 font-bold flex items-center gap-1">‚Üê Volver</button>
                    <div className="bg-white p-6 rounded-2xl shadow-lg space-y-6">
                        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Camera c="w-6 h-6 text-emerald-500"/> Reportar Hallazgo</h2>
                        <div className="border-2 border-dashed border-slate-300 rounded-xl h-48 flex items-center justify-center relative bg-slate-50 overflow-hidden group cursor-pointer hover:bg-slate-100 transition">
                            {form.image ? <img src={form.image} className="w-full h-full object-cover"/> : (
                                <div className="text-center p-4">
                                    <Upload c="w-8 h-8 text-slate-400 mx-auto mb-2"/>
                                    <span className="text-slate-500 font-medium">Toca para subir foto</span>
                                </div>
                            )}
                            <input type="file" accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => handleImage(e, 'report')}/>
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-2">Ubicaci√≥n (Marca en el mapa)</label>
                            <InteractiveMap onLocationSelect={(c) => setForm({...form, coords: c})} />
                            <input type="text" placeholder="Referencia escrita (Ej: Frente al banco...)" className="w-full p-3 border mt-3 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" onChange={e => setForm({...form, locationDesc: e.target.value})}/>
                        </div>
                        <div>
                             <label className="block text-sm font-bold text-slate-700 mb-2">Descripci√≥n</label>
                             <textarea placeholder="Raza, color, tama√±o, collar..." className="w-full p-3 border rounded-lg resize-none focus:ring-2 focus:ring-emerald-500 outline-none" rows="3" onChange={e => setForm({...form, breed: e.target.value, desc: e.target.value})}></textarea>
                        </div>
                        <button onClick={handlePublish} disabled={uploading || !form.image || !form.coords} className="w-full bg-emerald-500 text-white py-3 rounded-xl font-bold text-lg shadow-md hover:bg-emerald-600 disabled:bg-slate-300 disabled:cursor-not-allowed transform active:scale-95 transition">
                            {uploading ? 'Guardando...' : 'Publicar Reporte'}
                        </button>
                    </div>
                </div>
            );

            if (view === 'find') return (
                <div className="min-h-screen p-4 max-w-lg mx-auto flex flex-col items-center justify-center text-center animate-fade-in">
                    <button onClick={() => setView('home')} className="absolute top-4 left-4 text-slate-500 font-bold">‚Üê Volver</button>
                    <div className="bg-white p-8 rounded-2xl shadow-lg w-full">
                        <h2 className="text-2xl font-bold mb-2 text-slate-800">Buscar Mascota</h2>
                        <p className="text-slate-500 mb-6 text-sm">Sube una foto de referencia para ver si alguien la ha visto.</p>
                        <div className="border-2 border-dashed border-amber-300 bg-amber-50 rounded-2xl h-64 flex flex-col items-center justify-center relative cursor-pointer hover:bg-amber-100 transition group">
                            <Upload c="w-12 h-12 text-amber-500 mb-3 group-hover:scale-110 transition-transform"/>
                            <span className="text-amber-700 font-bold text-lg">Subir Foto</span>
                            <p className="text-amber-600/60 text-xs mt-1">JPG o PNG</p>
                            <input type="file" accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => handleImage(e, 'find')}/>
                        </div>
                    </div>
                </div>
            );

            if (view === 'results') return (
                <div className="min-h-screen p-4 max-w-4xl mx-auto animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                         <button onClick={() => setView('home')} className="font-bold text-slate-600 hover:text-emerald-600 transition">‚Üê Volver al Inicio</button>
                         <h2 className="text-2xl font-bold text-amber-600 flex items-center gap-2"><Search c="w-6 h-6"/> Resultados</h2>
                    </div>
                    {loading ? (
                        <div className="text-center py-20">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500 mx-auto mb-4"></div>
                            <p className="text-slate-500">Buscando en la base de datos...</p>
                        </div>
                    ) : (
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {dogs.map(dog => (
                                <div key={dog.id} className="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-100 hover:shadow-md transition group">
                                    <div className="h-48 bg-slate-200 relative overflow-hidden">
                                        <img src={dog.image} className="w-full h-full object-cover group-hover:scale-105 transition duration-500"/>
                                        {dog.gps && <a href={`https://www.google.com/maps/search/?api=1&query=${dog.gps.lat},${dog.gps.lng}`} target="_blank" className="absolute bottom-2 right-2 bg-white/90 px-3 py-1 rounded-full shadow-sm text-xs font-bold text-emerald-600 hover:bg-emerald-500 hover:text-white transition flex items-center gap-1 backdrop-blur-sm"><MapIcon c="w-3 h-3"/> Mapa</a>}
                                    </div>
                                    <div className="p-4">
                                        <h3 className="font-bold text-slate-800 text-lg mb-1">{dog.breed}</h3>
                                        <p className="text-sm text-slate-600 line-clamp-2">{dog.description}</p>
                                        <div className="mt-3 pt-3 border-t border-slate-50 flex items-center justify-between">
                                            <span className="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">{dog.date}</span>
                                            <span className="text-xs text-slate-500 flex items-center gap-1"><MapIcon c="w-3 h-3 text-emerald-500"/> {dog.location}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {dogs.length === 0 && (
                                <div className="col-span-full text-center py-16 bg-white rounded-2xl border border-slate-100 shadow-sm">
                                    <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4"><Search c="w-8 h-8 text-slate-400"/></div>
                                    <h3 className="text-lg font-bold text-slate-700">No hay reportes a√∫n</h3>
                                    <p className="text-slate-500 mt-1">S√© el primero en reportar un avistamiento.</p>
                                    <button onClick={() => setView('report')} className="mt-4 text-emerald-600 font-bold hover:underline">Reportar ahora</button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );

            if (view === 'success') return (
                <div className="min-h-screen flex flex-col items-center justify-center text-center p-4 animate-fade-in-up">
                    <div className="w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mb-6 shadow-lg ring-8 ring-emerald-50">
                        <CheckCircle c="w-12 h-12 text-emerald-600"/>
                    </div>
                    <h2 className="text-3xl font-extrabold text-slate-800 mb-2">¬°Reporte Guardado!</h2>
                    <p className="text-slate-500 mt-2 max-w-md text-lg">Gracias por tu ayuda. La informaci√≥n ya est√° disponible para toda la comunidad.</p>
                    <button onClick={() => setView('home')} className="mt-8 bg-emerald-500 text-white px-10 py-4 rounded-full font-bold shadow-lg hover:bg-emerald-600 hover:shadow-xl transform hover:-translate-y-1 transition-all">
                        Volver al Inicio
                    </button>
                </div>
            );
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
